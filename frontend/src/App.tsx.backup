import React from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { Toaster } from 'react-hot-toast';

// Pages
import EnhancedDashboard from './pages/EnhancedDashboard';
import GoogleLogin from './pages/GoogleLogin';
import OverlayView from './pages/OverlayView';

// Components
import LoadingSpinner from './components/common/LoadingSpinner';
import ProtectedRoute from './components/auth/ProtectedRoute';
import Navbar from './components/layout/Navbar';

// Services
import { googleAuthService } from './services/googleAuthService';

// Styles
import './App.css';

const App: React.FC = () => {
  const [user, setUser] = React.useState(null);
  const [initializing, setInitializing] = React.useState(true);
  const [isAuthenticated, setIsAuthenticated] = React.useState(false);

  // 監聽 Google 認證狀態
  React.useEffect(() => {
    const unsubscribe = googleAuthService.onAuthStateChanged((firebaseUser) => {
      setUser(firebaseUser);
      setIsAuthenticated(!!firebaseUser);
      setInitializing(false);
    });

    return () => unsubscribe();
  }, []);

  // 如果正在初始化，顯示載入畫面
  if (initializing) {
    return (
      <div className="app-loading" style={{
        minHeight: '100vh',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%)',
        color: 'white'
      }}>
        <LoadingSpinner size="large" />
        <p>初始化中...</p>
      </div>
    );
  }

  return (
    <div className="App">
      {/* Toast 通知 */}
      <Toaster
        position="top-right"
        toastOptions={{
          duration: 4000,
          style: {
            background: 'rgba(15, 15, 35, 0.95)',
            color: '#ffffff',
            border: '1px solid rgba(255, 255, 255, 0.1)',
            borderRadius: '12px',
            backdropFilter: 'blur(20px)'
          }
        }}
      />

      {/* 導航欄 - 僅在認證後顯示 */}
      {isAuthenticated && <Navbar />}

      {/* 主要內容區域 */}
      <div style={{ paddingTop: isAuthenticated ? '70px' : '0' }}>
        <Routes>
          {/* Google 登入頁面 */}
          <Route 
            path="/login" 
            element={isAuthenticated ? <Navigate to="/dashboard" replace /> : <GoogleLogin />} 
          />
          
          {/* OBS 疊加視圖 - 不需要認證 */}
          <Route path="/overlay/:streamerId" element={<OverlayView />} />
          
          {/* 受保護的路由 */}
          <Route path="/dashboard" element={
            <ProtectedRoute>
              <EnhancedDashboard />
            </ProtectedRoute>
          } />
          
          {/* 預設重定向 */}
          <Route 
            path="/" 
            element={isAuthenticated ? <Navigate to="/dashboard" replace /> : <Navigate to="/login" replace />} 
          />
          
          {/* 404 處理 */}
          <Route path="*" element={
            <div style={{ 
              padding: '2rem', 
              textAlign: 'center', 
              color: 'white',
              background: 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%)',
              minHeight: '100vh',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center'
            }}>
              <h1>404 - 頁面不存在</h1>
              <p>您訪問的頁面不存在</p>
            </div>
          } />
        </Routes>
      </div>
    </div>
  );
};

export default App;